<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8" />
	<meta name="format-detection" content="telephone=no" />
	<meta name="msapplication-tap-highlight" content="no" />
	<meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width" />
	<meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' gap:; style-src 'self' 'unsafe-inline'; script-src 'self' http://* 'unsafe-eval' 'unsafe-inline'; img-src 'self' data: http:; media-src *"/>
	<title>출금신청</title>
	<link rel="stylesheet" type="text/css" href="../css/default.css"/>
	<link rel="stylesheet" type="text/css" href="../css/style.css"/>
	<link rel="stylesheet" type="text/css" href="../css/nav.css"/>
	<script src="../js/jquery.min.js"></script>
	<script src="../js/jquery.form.min.js"></script>
	<script src="../js/menu.js"></script>
</head>
<body>
	<div id="header">
		<h1>출금신청</h1>
		<a href="javascript:history.back();" class="header_btn_l btn_back">뒤로</a>
	</div>
	<div class="bk_gray">
		<form id="point_req_form" method="post" enctype="multipart/form-data">
			<input type="hidden" name="w" value="">
			<input type="hidden" name="mb_id" value="" id="mb_id">
			<input type="hidden" name="bo_table" value="point">
			<input type="hidden" name="ca_name" value="신청">
			<div class="m_reg_li">
				<p class="title rg_title">신청 전 하단의 안내된 내용을<br>꼭 읽어보신 후 포인트 출금 신청 해주세요.</p>
				<ul>
					<li>
						<label class="title" for="">은행</label>
						<div class="dv_input">
							<select name="wr_2" id="wr_2">
								<option value="">은행선택</option>
								<option value="국민은행">국민은행</option>
								<option value="하나은행">하나은행</option>
								<option value="기업은행">기업은행</option>
								<option value="우리은행">우리은행</option>
								<option value="신한은행">신한은행</option>
								<option value="SC제일은행">SC제일은행</option>
								<option value="농협중앙회">농협중앙회</option>
								<option value="지역농협">지역농협</option>
								<option value="씨티은행">씨티은행</option>
								<option value="대구은행">대구은행</option>
								<option value="부산은행">부산은행</option>
							</select>
						</div>
					</li>
					<li>
						<label class="title" for="">계좌번호</label>
						<div class="dv_input">
							<div class="input_txt">
								<input class="input" type="text" name="wr_subject" id="wr_subject" value="" placeholder="계좌번호 입력" required>
							</div>
						</div>
					</li>
					<li>
						<label class="title" for="">금액<span class="reg_t_sub"> (보유포인트 <span class="color_blog" id="mb_point"></span>)</span></label>
						<input type="hidden" id="mb_point_chk" value="">
						<input type="hidden" id="mb_point_sum" value="">
						<div class="dv_input">
							<div class="input_txt">
								<input class="input" type="text" name="wr_1" id="wr_1" value="" numberOnly placeholder="출금 금액 입력 (만원 단위로 출금 가능)" required onkeyup="cmaComma(this);" onchange="cmaComma(this);">
							</div>
						</div>
						<p class="conf_txt" id="conf_txt_point"></p>
					</li>
					<li>
						<label class="title" for="">예금주</label>
						<div class="dv_input">
							<div class="input_txt">
								<input class="input" type="text" name="wr_4" id="wr_4" value="" placeholder="예금주 입력" required>
							</div>
						</div>
					</li>
					<li>
						<label class="title" for="">환금금액<span class="reg_t_sub"> (3만원 초과 금액은 3.3% 공제)</span></label>
						<div class="dv_input">
							<div class="input_txt">
								<input class="input" type="text" name="wr_10" id="wr_10" value="" placeholder="0" required readonly>
							</div>
						</div>
					</li>
					<li>
						<label class="title" for="">신분증<span class="reg_t_sub"> (최초 1회만 첨부 - 1MB 이하만 가능)</span></label>
						<div id="id_card" style="font-size:12px"></div>
						<input type="hidden" id="id_chk" value="0">
						<div class="add_photo_b" id="id_file_b">
							<span class="btn_add_photo">추가버튼</span>
							<input type="file" onchange="fileInfo_p(this)" name="bf_file[]">
							<span class="preview_photo" id="id_card_photo"></span>
						</div>
					</li>
				</ul>
			</div>
			<div class="m_reg_li terms_wrap">
				<p class="title">약관동의</p>
				<div class="terms_use terms_all">
					<p>모두동의</p>
					<input type="checkbox" id="chk_all">
					<label for="chk_all"><span></span></label>
				</div>
				<em class="em_b"></em>
				<div class="terms_use">
					<span class="ct">[필수]</span><a href="#none" class="terms" id="terms_pt">포인트 출금 안내 <span class="ft_10">(전문보기)</span></a>
					<input type="checkbox" id="chk_1" name="check">
					<label for="chk_1"><span></span></label>
				</div>
				<div class="terms_use">
					<span class="ct">[필수]</span><a href="#none" class="terms" id="terms_pv">개인정보 수집 안내 <span class="ft_10">(전문보기)</span></a>
					<input type="checkbox" id="chk_2" name="check">
					<label for="chk_2"><span></span></label>
				</div>
			</div>
			<div class="reg_btn">
				<div class="btn_wrap btn_ok">
					<a href="#none" id="btn_submit" class="btn_submit">출금신청</a>
				</div>
				<div class="bottom_txt">출금신청에 문제가 있을 시 1:1 문의에<br>내용을 남겨주시면 친절히 안내해드리겠습니다.</div>
				<div class="bottom_txt bt_footer">광고/제휴문의 고객센터 <a href="tel:02-3144-2110">02-3144-2110</a><br>일반회원 고객센터 <a href="tel:02-6392-2121">02-6392-2121</a></div>
			</div>
		</form>
	</div>
	<!-- 팝업 -->
	<div id="pop"></div>
	
	<script>
	$(document).ready(function(){
		// 회원정보 불러오기
		//var mb_id = 'qwe';
		var mb_id = member['mb_id'];
		var params = {"mb_id":mb_id};
		$('#mb_id').val(mb_id);
		$.ajax({      
			type:"POST",
			data:params,			
			url:"http://modublog.co.kr/app_public/ajax/a_point_view.php",      
			success:function(data){
				//회원 DB 가져오기
				$.each(data[0],function(key,value){
					$('#mb_point').html(value.mb_point_format + "p");
					$('#mb_point_chk').val(value.mb_point_format);
					$('#wr_4').val(value.mb_name);
					if(value.mb_3){
						$('#id_file_b').html("");
						$('#id_card').text("기존에 첨부하신 정보가 있습니다.");
						$('#id_chk').val("1");
					}
				});
				//신청 누적액
				$.each(data[2],function(key,value){
					$('#mb_point_sum').val(value.total_cash);
				});
				console.log(data);
			},   
			error:function(e){  
				console.log(e.responseText);  
			}  		
		})
		
		// 약관동의 팝업 - 불러오기
		$(document).on('click','.terms',function(){
			var terms_id = $(this).attr('id');
			$('#pop').load("popup.html", function(){
				$.ajax({      
					url: 'http://modublog.co.kr/app_public/ajax/a_terms.php',
					//data: {'terms_id':terms_id},
					type: 'POST',
					success: function(args){
						if(terms_id == 'terms_pv'){
							$('.terms_title').html("개인정보 수집 및 이용 동의");
							$('.terms_cont').html(args.cf_privacy);
							$('.terms_sub').html('<h3>- 부정출금 방지를 위하여 본인 신분증상의 주민등록번호를 수집하며, 출금 이후 2년간 정보를 보관합니다.</h3>');
						}else if(terms_id == 'terms_pt'){
							$('.terms_title').html("포인트 출금 안내");
							$('.terms_sub').html('<h3 class="prec_sub">포인트 출금 안내사항</h3>');
							$('.terms_cont').html('<div class="prec"><ul><li>출금 신청은 만원 단위로 가능합니다.</li><li>포인트 출금은 신청하신 월 기준 말일에 지급됩니다.<span style="display:block;font-size:10px">※ 단, 3.3% (사업소득세 3%, 사업소득지방세 0.3%) 세금공제</span></li><li>리뷰 규정 위배 시 해당 포인트가 차감될 수 있으니 이 점 유의해주시기 바랍니다.</li><li>선정된 체험의 체험여부 또는 리뷰 확인이 불가한 경우, 해당 월의 출금은 보류 및 이월되오니 유의바랍니다</li><li>신분증 확인이 안 될 경우 출금이 불가능합니다.</li><li>신청자와 예금주는 반드시 동일해야 합니다.</li><li>해당 개인정보는 배정된 담당자를 제외하고는 열람할 수 없으며, 어떠한 경우에도 외부 유출이 되지 않습니다.<span style="display:block;font-size:10px">※ 단, 미성년자의 경우 보호자의 신분증 파일과 명의가 일치하는 계좌를 첨부하여야 정상 출금이 가능합니다.</span></li></ul></div>');
						}
					}, 
					error:function(e){  	
					}  
				});
			});
			return false;
		})
		// 약관동의 체크박스
		// 전체동의 선택 시 모든 체크박스 상태 checked true|false
		$('#chk_all').click(function(){
			if($('#chk_all').prop('checked')){
				$('input[name=check]').prop('checked',true);
				$('.btn_ok > a').addClass('on');
			}else{
				$('input[name=check]').prop('checked',false);
				$('.btn_ok > a').removeClass('on');
			}
		})
		// 모든 체크박스 checked 일 때 확인 버튼 on
		$('input[name=check]').click(function(){
			if($('#chk_1').prop('checked') && $('#chk_2').prop('checked')){
				$('.btn_ok > a').addClass('on');
			}else{
				$('.btn_ok > a').removeClass('on');
			}
		})
		
	})
	
	// 금액
	function cmaComma(obj) {
	    var firstNum = obj.value.substring(0,1); // 첫글자 확인 변수
	    var strNum = /^[/,/,0,1,2,3,4,5,6,7,8,9,/]/; // 숫자와 , 만 가능
	    var str = "" + obj.value.replace(/,/gi,''); // 콤마 제거  
	    var regx = new RegExp(/(-?\d+)(\d{3})/);  
	    var bExists = str.indexOf(".",0);  
	    var strArr = str.split('.');  
	 
	    if (!strNum.test(obj.value)) {
	        //$('#conf_txt_point').html("숫자만 입력해주세요. 특수문자 또는 한글/영문은 사용할수 없습니다.");
	        //obj.value = 1;
	        //obj.focus();
	
			//$("#txt_price").text(0);
			//$("#wr_10").val(0);
	        return false;
	    }
	    if ((firstNum < "0" || "9" < firstNum)){
	        //$('#conf_txt_point').html("숫자만 입력해주세요.");
	        //obj.value = 1;
	        //obj.focus();
	        return false;
	    }
	 	// 금액입력 - 환급금액 계산
	    while(regx.test(strArr[0])){  
	        strArr[0] = strArr[0].replace(regx,"$1,$2");
			var input_point = removeComma($("#wr_1").val());
			if (input_point <= 30000) {
				var tax_str = parseInt( input_point );
				$("#wr_10").val( commaSplit(tax_str) );
			} else {
				var tax_str = parseInt( input_point - (input_point * 0.033) );
				$("#wr_10").val( commaSplit(tax_str) );
			}
			$("#wr_10").val( commaSplit(tax_str) );
	    }
	    if (bExists > -1)  {
	        obj.value = strArr[0] + "." + strArr[1];  
	    } else  {
	        obj.value = strArr[0]; 
	    }
	}
	// ',' 나누는 부분
	function commaSplit(n) { 
	    var txtNumber = '' + n;
	    var rxSplit = new RegExp('([0-9])([0-9][0-9][0-9][,.])');
	    var arrNumber = txtNumber.split('.');
	    arrNumber[0] += '.';
	    do {
	        arrNumber[0] = arrNumber[0].replace(rxSplit, '$1,$2');
	    }
	    while (rxSplit.test(arrNumber[0]));
	    if(arrNumber.length > 1) {
	        return arrNumber.join('');
	    } else {
	        return arrNumber[0].split('.')[0];
	    }
	}
	// ',' 제거
	function removeComma(n) {  
		if ( typeof n == "undefined" || n == null || n == "" ) {
			return "";
		}
		var txtNumber = '' + n;
		return Number(txtNumber.replace(/(,)/g, ""));
	}
	
	// 파일 첨부
	function fileInfo_p(f){
		var file = f.files; // 파일의 정보
		// file 은 배열이므로 file[0] 으로 접근
		var maxSize = 5242880;
		var fileSize = Math.round(file[0].size);
		
        if(fileSize > maxSize){
            alert("첨부파일 사이즈는 5MB 이내로 등록 가능합니다.");
            return;
        }else if(file[0].type.indexOf('image') < 0){ // 선택한 파일이 이미지인지 확인
			alert('이미지 파일만 선택하세요.');
			return;
		}
		
		var reader = new FileReader(); // FileReader 객체 사용
		reader.onload = function(rst){
			$('#id_card_photo').html('<img id="id_photo" style="position:absolute;top:0;left:0;bottom:0;right:0;vertical-align:middle;width:100%;height:100%;vertical-align:top;border:none">');
			$('#id_photo').attr("src", rst.target.result); 
			//$('#img_box1').css('background','url('+rst.target.result+')center center / cover no-repeat');
			// append 메소드를 사용해서 이미지 추가
			// 이미지는 base64 문자열로 추가
		}
		reader.readAsDataURL(file[0]); // 파일을 읽는다
	}
	
	// 등록버튼 클릭
	$(document).on('click','.btn_submit.on',function(){
		var wr_1 = $('#wr_1').val();
		var wr_4 = $('#wr_4').val();
		var mb_point = $('#mb_point_chk').val();
		var mb_point_sum = $('#mb_point_sum').val();
		var wr_subject = $('#wr_subject').val();
		var id_file = $('#id_file').val();
		var id_chk = $('#id_chk').val();
		var agree1 = $('#chk_1:checkbox:checked').val();
		var agree2 = $('#chk_2:checkbox:checked').val();
		
		if(wr_1 == ''){
			alert("출금 금액을 입력해주세요.");
			$('#wr_1').focus();
			return false;
		}
		if ((removeComma(wr_1) % 10000) != 0) {
			alert("출금은 만원단위로 신청 가능합니다.");
			$('#wr_1').focus();
			return false;
		}
		if (removeComma(wr_1) < 50000) {
			alert("5만 포인트 이상 출금 가능합니다.");
			$('#wr_1').focus();
			return false;
		}
		if (removeComma(wr_1) > removeComma(mb_point)) {
			alert("출금 금액이 보유 포인트 보다 많습니다.");
			$('#wr_1').focus();
			return false;
		}
		if ((removeComma(mb_point_sum) + removeComma(wr_1)) >  removeComma(mb_point)) {
			alert("누적 신청 금액이 보유 포인트 보다 많습니다.");
			$('#wr_1').focus();
			return false;
		}
		if(wr_4 == ''){
			alert("예금주명을 입력해주세요.");
			$('#wr_4').focus();
			return false;
		}
		if(wr_subject == ''){
			alert("계좌번호를 입력해주세요.");
			$('#wr_subject').focus();
			return false;
		}
		if(id_file == '' && id_chk == '0'){
			alert("신분증 파일을 선택해주세요.");
			$('#id_file').focus();
			return false;
		}
		if(agree1 != 'on' || agree2 != 'on'){
			alert("이용약관에 동의해주세요.");
			return false;
		}
		$(this).attr("class","btn_submit off");
		
		$('#point_req_form').ajaxForm({
			url: "http://modublog.co.kr/app_public/ajax/a_point_update.php",
			enctype: "multipart/form-data",
			success: function(args){
				if(args == "1"){
					location.href="point_view.html";
				}
			},
			error: function(request,status,error){
				console.log(request.responseText);
			}
		});
		$("#point_req_form").submit();
	})
	</script>
</body>
</html>